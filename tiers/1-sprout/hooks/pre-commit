#!/bin/bash
# aix pre-commit hook - Tier 1 (Sprout)
# Basic quality checks before committing

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo "No staged files to check."
    exit 0
fi

# =============================================================================
# CHECK 1: File size limits
# =============================================================================
echo ""
echo "Checking file sizes..."

# Size limits (in lines)
SOFT_LIMIT=300
HARD_LIMIT=500

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        # Only check code files
        case "$file" in
            *.js|*.ts|*.jsx|*.tsx|*.py|*.go|*.rs|*.rb|*.java)
                lines=$(wc -l < "$file" | tr -d ' ')
                if [ "$lines" -gt "$HARD_LIMIT" ]; then
                    echo -e "${RED}BLOCKED${NC}: $file has $lines lines (max: $HARD_LIMIT)"
                    ERRORS=$((ERRORS + 1))
                elif [ "$lines" -gt "$SOFT_LIMIT" ]; then
                    echo -e "${YELLOW}WARNING${NC}: $file has $lines lines (soft limit: $SOFT_LIMIT)"
                    WARNINGS=$((WARNINGS + 1))
                fi
                ;;
        esac
    fi
done

# =============================================================================
# CHECK 2: No focused tests (.only, fit, fdescribe)
# =============================================================================
echo ""
echo "Checking for focused tests..."

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        case "$file" in
            *.test.js|*.test.ts|*.spec.js|*.spec.ts|*_test.go|*_test.py)
                # Check for common focus patterns
                if grep -n "\.only\|fit(\|fdescribe(\|it\.only\|describe\.only" "$file" 2>/dev/null; then
                    echo -e "${RED}BLOCKED${NC}: $file contains focused test (.only, fit, etc.)"
                    ERRORS=$((ERRORS + 1))
                fi
                ;;
        esac
    fi
done

# =============================================================================
# CHECK 3: No debug statements
# =============================================================================
echo ""
echo "Checking for debug statements..."

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        case "$file" in
            *.js|*.ts|*.jsx|*.tsx)
                if grep -n "console\.log\|debugger" "$file" 2>/dev/null | head -3; then
                    echo -e "${YELLOW}WARNING${NC}: $file contains console.log or debugger"
                    WARNINGS=$((WARNINGS + 1))
                fi
                ;;
            *.py)
                if grep -n "print(\|breakpoint()\|pdb\." "$file" 2>/dev/null | head -3; then
                    echo -e "${YELLOW}WARNING${NC}: $file contains print/breakpoint"
                    WARNINGS=$((WARNINGS + 1))
                fi
                ;;
        esac
    fi
done

# =============================================================================
# CHECK 4: No TODO/FIXME in new code (warning only)
# =============================================================================
echo ""
echo "Checking for TODOs..."

for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        case "$file" in
            *.js|*.ts|*.jsx|*.tsx|*.py|*.go|*.rs|*.rb)
                if grep -n "TODO\|FIXME\|XXX\|HACK" "$file" 2>/dev/null | head -3; then
                    echo -e "${YELLOW}INFO${NC}: $file contains TODO/FIXME markers"
                fi
                ;;
        esac
    fi
done

# =============================================================================
# SUMMARY
# =============================================================================
echo ""
echo "=========================================="
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}BLOCKED: $ERRORS error(s) found${NC}"
    echo "Fix the errors above before committing."
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}PASSED with $WARNINGS warning(s)${NC}"
    echo "Consider addressing the warnings."
    exit 0
else
    echo -e "${GREEN}PASSED: All checks passed${NC}"
    exit 0
fi
